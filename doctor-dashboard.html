<!DOCTYPE html>
<html>
<head>
<title>‚ú® Smart Doctor + Queue Live System</title>

<style>

/* ================= BACKGROUND ================= */

body{
margin:0;
font-family:'Segoe UI',Arial;
background:linear-gradient(135deg,#c3ecff,#e0c3fc);
overflow:hidden;
}

/* floating medical shapes */

.shape{
position:absolute;
border-radius:50%;
background:rgba(255,255,255,0.25);
backdrop-filter:blur(15px);
animation:float 10s infinite ease-in-out;
z-index:-1;
}

.s1{width:200px;height:200px;top:5%;left:5%;}
.s2{width:150px;height:150px;bottom:10%;right:10%;animation-delay:2s;}
.s3{width:100px;height:100px;top:40%;right:20%;animation-delay:4s;}

@keyframes float{
0%{transform:translateY(0);}
50%{transform:translateY(-25px);}
100%{transform:translateY(0);}
}

/* ================= LAYOUT ================= */

.container{
display:flex;
height:100vh;
padding:20px;
gap:20px;
}

/* ================= DOCTOR PANEL ================= */

.doctorPanel{
width:35%;
background:rgba(255,255,255,0.65);
backdrop-filter:blur(20px);
border-radius:20px;
padding:25px;
box-shadow:0 10px 30px rgba(0,0,0,.2);
overflow:auto;
}

.doctorPanel h2{
text-align:center;
background:linear-gradient(45deg,#2196f3,#4caf50);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

/* ================= BUTTONS ================= */

button{
width:100%;
padding:14px;
margin:10px 0;
border:none;
border-radius:30px;
font-size:16px;
cursor:pointer;
transition:.3s;
color:white;
font-weight:bold;
}

button:hover{
transform:scale(1.05);
box-shadow:0 6px 20px rgba(0,0,0,.2);
}

.available{background:linear-gradient(45deg,#4caf50,#66bb6a);}
.emergency{background:linear-gradient(45deg,#f44336,#e57373);}
.break{background:linear-gradient(45deg,#ff9800,#ffb74d);}
.call{background:linear-gradient(45deg,#2196f3,#64b5f6);}

/* ================= STATUS BOX ================= */

.statusBox{
background:white;
padding:14px;
border-radius:12px;
margin-top:15px;
box-shadow:0 4px 12px rgba(0,0,0,.1);
font-weight:bold;
transition:.3s;
}

.statusBox.availableGlow{
box-shadow:0 0 20px #4caf50;
}

/* ================= QUEUE PANEL ================= */

.queuePanel{
flex:1;
background:rgba(255,255,255,0.65);
backdrop-filter:blur(20px);
border-radius:20px;
padding:25px;
box-shadow:0 10px 30px rgba(0,0,0,.2);
overflow:auto;
}

.queuePanel h2{
text-align:center;
background:linear-gradient(45deg,#2e7d32,#2196f3);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

/* ================= QUEUE CARD ================= */

.card{
background:white;
padding:25px;
border-radius:20px;
margin:auto;
max-width:520px;
box-shadow:0 8px 20px rgba(0,0,0,.15);
}

.big{
font-size:36px;
font-weight:bold;
color:#2e7d32;
}

.section{margin-top:20px;}

/* ================= TOKEN CARDS ================= */

.tokenCard{
padding:12px;
margin:8px 0;
border-radius:12px;
background:#e3f2fd;
transition:.3s;
}

.tokenCard:hover{
transform:translateX(5px);
}

.current{
background:#c8e6c9;
border-left:6px solid #2e7d32;
font-weight:bold;
}

.servingBadge{
background:#4caf50;
color:white;
padding:4px 8px;
border-radius:8px;
font-size:12px;
margin-left:8px;
}

.totalBox{
text-align:center;
margin-bottom:15px;
font-weight:bold;
color:#444;
}

</style>
</head>

<body>

<div class="shape s1"></div>
<div class="shape s2"></div>
<div class="shape s3"></div>

<div class="container">

<!-- ================= DOCTOR SIDE ================= -->

<div class="doctorPanel">

<h2>üë®‚Äç‚öïÔ∏è Doctor Control Panel</h2>

<button class="available" onclick="setStatus('AVAILABLE',0)">
üü¢ Available
</button>

<button class="emergency" onclick="setStatus('EMERGENCY',15)">
üö® Emergency (15 min delay)
</button>

<button class="break" onclick="setStatus('REFRESHMENT',30)">
‚òï Break (30 min delay)
</button>

<button class="call" onclick="callNext()">
‚ñ∂ Call Next Patient
</button>

<div id="doctorStatus" class="statusBox"></div>

</div>

<!-- ================= QUEUE SIDE ================= -->

<div class="queuePanel">

<h2>üîî Live Queue Tracker</h2>

<div class="card">

<div class="totalBox" id="totalBox"></div>

<div id="myStatus"></div>

<div class="section">
<h3>Patients Before You</h3>
<div id="beforeList"></div>
</div>

</div>

</div>

</div>

<script>

const API="http://localhost:3000";
const token = Number(localStorage.getItem("patientToken"));

let lastPosition = null;

/* ---------- DOCTOR CONTROL ---------- */

async function setStatus(status,delay){
await fetch(API+"/doctor/status",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({status,delay})
});
loadDoctorStatus();
}

async function callNext(){
await fetch(API+"/call-next",{method:"POST"});
}

/* ---------- LOAD DOCTOR STATUS ---------- */

async function loadDoctorStatus(){
const d=await fetch(API+"/doctor/status").then(r=>r.json());

doctorStatus.innerHTML=
`Status: ${d.doctorStatus}<br>Delay: ${d.delayMinutes} mins`;

if(d.doctorStatus==="AVAILABLE")
doctorStatus.classList.add("availableGlow");
else
doctorStatus.classList.remove("availableGlow");
}

/* ---------- VOICE ---------- */

function announceTurn(tokenNumber){
speechSynthesis.cancel();
const msg = new SpeechSynthesisUtterance(
`Token ${tokenNumber}, please proceed to the doctor`
);
speechSynthesis.speak(msg);
}

/* ---------- BEEP ---------- */

function beep(){
const ctx=new AudioContext();
const osc=ctx.createOscillator();
osc.frequency.setValueAtTime(850,ctx.currentTime);
osc.connect(ctx.destination);
osc.start();
setTimeout(()=>osc.stop(),300);
}

/* ---------- QUEUE TRACKER ---------- */

async function loadQueue(){

if(!token){
beforeList.innerHTML="No token found";
return;
}

const queue=await fetch(API+"/queue").then(r=>r.json());

/* üî• IMPORTANT: numeric ordering */
queue.sort((a,b)=>a.token-b.token);

totalBox.innerHTML="Total Patients Waiting: "+queue.length;

const myIndex=queue.findIndex(p=>p.token===token);

const my=await fetch(API+"/patient/"+token).then(r=>r.json());

if(!my.position){
myStatus.innerHTML="Token not found in queue";
return;
}

/* announce only when reaching position 1 */

if(my.position===1 && lastPosition!==1){
beep();
announceTurn(my.token);
}

lastPosition=my.position;

myStatus.innerHTML=
`üéü Token: <span class="big">${my.token}</span><br>
üìç Position: ${my.position}<br>
‚è± Estimated Wait: ${my.estimated_wait_minutes} mins<br>
üë®‚Äç‚öïÔ∏è Doctor Status: ${my.doctorStatus}`;

const before=myIndex>0?queue.slice(0,myIndex):[];

beforeList.innerHTML=
before.length===0
? `<div class="tokenCard current">
üéü Token ${my.token}
<span class="servingBadge">SERVING</span>
</div>`
: before.map((p,i)=>`
<div class="tokenCard">
üéü Token ${p.token}<br>
üìç Position: ${i+1}
</div>
`).join("");

}

/* ---------- AUTO REFRESH ---------- */

setInterval(()=>{
loadQueue();
loadDoctorStatus();
},2000);

loadQueue();
loadDoctorStatus();

</script>

</body>
</html>
